@page "/"
@using System.Text.Json
@using System.Text.Json.Serialization
@using System.Text.RegularExpressions
@using System.Text
@using System.Globalization
@using Microsoft.JSInterop
@using NBitcoin

@implements IAsyncDisposable

@inject HttpClient Http
@inject IJSRuntime JSRuntime

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<link rel="icon" type="image/x-icon" href="favicon.ico">

<style>
    body {
        transition: background-color 0.3s, color 0.3s;
    }

    .status-warning {
        color: var(--bs-orange);
    }

    .copy-btn {
        cursor: pointer;
    }

    .address-copied {
        background-color: var(--bs-info-bg-subtle) !important;
    }
</style>


<PageTitle>BTC Utility Web App</PageTitle>

<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="copyToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <i class="bi bi-clipboard-check-fill me-2"></i>
            <strong class="me-auto">Success</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
            @_toastMessage
        </div>
    </div>
</div>


<div class="container my-4">
    <header class="text-center mb-4">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 mb-3">
            <h1 class="display-5 d-inline-flex align-items-center m-0">
                <img src="images/bitcoin.ico" alt="Bitcoin Icon" style="width: 40px; height: 40px; margin-right: 0.75rem;">
                BTC Utility Web App
            </h1>
            <div class="d-flex align-items-center gap-2">
                @if (_currentBtcPrice.HasValue)
                {
                    <div class="d-flex align-items-center gap-2 p-1 rounded" style="background-color: var(--bs-body-bg); border: 1px solid var(--bs-border-color-translucent);">
                        <span class="badge bg-success-subtle border border-success-subtle text-success-emphasis rounded-pill fs-6"
                              data-bs-toggle="tooltip" data-bs-placement="bottom" title="Last updated: @_lastPriceUpdate?.ToString("HH:mm:ss")">
                            <img src="images/bitcoin.ico" style="width: 16px; height: 16px; margin-top: -2px;" />
                            $@_currentBtcPrice.Value.ToString("N2")
                        </span>
                        <small class="text-muted" style="font-size: 0.75em;">(Updated: @_lastPriceUpdate?.ToString("HH:mm:ss"))</small>
                    </div>
                }
                <button class="btn btn-outline-info" @onclick="ShowHelpModal"><i class="bi bi-question-circle-fill"></i></button>
                <button class="btn btn-outline-secondary" @onclick="ToggleTheme">
                    <i class="bi @(_isDarkMode ? "bi-sun-fill" : "bi-moon-stars-fill")"></i>
                </button>
            </div>
        </div>
        <p class="lead text-muted">A web-based tool for generating BTC addresses and checking balances from an xpub.</p>
    </header>

    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-body p-4">

                    <div class="mb-3">
                        <label class="form-label fw-bold">1. Select or Enter your xpub</label>
                        <div class="input-group">
                            <select class="form-select" @onchange="OnSavedXpubSelected">
                                <option value="">-- Choose a saved xpub --</option>
                                @foreach (var alias in _config.SavedXpubs.Keys)
                                {
                                    <option value="@alias">@alias</option>
                                }
                            </select>
                            <button class="btn btn-secondary" type="button" @onclick="ShowConfigModal">Manage</button>
                        </div>
                        <textarea class="form-control mt-2" rows="3" placeholder="Or paste your xpub/ypub/zpub here..." @bind="_currentXpub" @bind:event="oninput"></textarea>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label for="networkSelect" class="form-label fw-bold">2. Network</label>
                            <select id="networkSelect" class="form-select" @bind="_selectedNetworkString">
                                <option value="Main">Main</option>
                                <option value="TestNet">Testnet</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="addressTypeSelect" class="form-label fw-bold">3. Address Type</label>
                            <select id="addressTypeSelect" class="form-select" @bind="_selectedAddressTypeString">
                                <option value="Segwit">Native Segwit (bc1...)</option>
                                <option value="SegwitP2SH">Segwit (3...)</option>
                                <option value="Legacy">Legacy (1...)</option>
                            </select>
                        </div>
                    </div>

                    <div class="d-flex justify-content-end mb-2">
                        <button class="btn btn-link btn-sm" type="button" @onclick="ToggleAdvancedSettings">
                            Advanced Settings <i class="bi @(_showAdvanced ? "bi-chevron-up" : "bi-chevron-down")"></i>
                        </button>
                    </div>

                    <div class="collapse @(_showAdvanced ? "show" : "")">
                        <div class="card card-body bg-body-tertiary mb-4">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="generateCount" class="form-label">Addresses to Generate</label>
                                    <input type="number" id="generateCount" class="form-control" @bind="_generateCount" min="1" max="1000">
                                </div>
                                <div class="col-md-6">
                                    <label for="gapLimit" class="form-label">Balance Scan Gap Limit</label>
                                    <input type="number" id="gapLimit" class="form-control" @bind="_gapLimit" min="1" max="100">
                                </div>
                            </div>
                            <div class="form-check form-switch mt-3">
                                <input class="form-check-input" type="checkbox" role="switch" id="checkUsedAddress" @bind="_checkIfAddressUsed">
                                <label class="form-check-label" for="checkUsedAddress">Verify if address has been used (slower)</label>
                            </div>
                            <div class="alert alert-warning mt-3 mb-0">
                                <strong>Warning:</strong>
                                <ul class="mb-0">
                                    <li>Setting a high <strong>Gap Limit</strong> may slow down the scan and could lead to rate limiting from the blockstream.info API.</li>
                                    <li>Generating a large number of <strong>Addresses</strong> may slow down your browser.</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-center gap-2">
                        <button class="btn btn-primary btn-lg px-4" @onclick="GenerateAddresses" disabled="@IsBusy">
                            <i class="bi bi-plus-circle"></i> @(_generatedAddresses.Any() ? "Generate More" : "Generate Addresses")
                        </button>
                        <button class="btn btn-success btn-lg px-4" @onclick="CheckBalance" disabled="@IsBusy">
                            <i class="bi bi-search"></i> Check Balance
                        </button>
                        <button class="btn btn-danger btn-lg px-4" @onclick="ClearResults" disabled="@IsBusy">
                            <i class="bi bi-x-circle"></i> Clear
                        </button>
                    </div>

                </div>
            </div>

            @if (IsBusy)
            {
                <div class="text-center mt-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 @(_isApproachingGapLimit ? "status-warning" : "")">@_statusMessage</p>
                </div>
            }

            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <div class="alert alert-danger mt-4">@_errorMessage</div>
            }

            @if (_generatedAddresses.Any())
            {
                <div class="card mt-4">
                    <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-2">
                        <span>Generated Addresses (@_generatedAddresses.Count)</span>
                        <div class="d-flex align-items-center gap-2">
                            <div class="input-group input-group-sm" style="width: 150px;">
                                <span class="input-group-text">Per Page</span>
                                <input type="number" class="form-control" @bind="_pageSize" @bind:event="oninput" min="5" max="100" @onchange="UpdateGenAddrPagination">
                            </div>
                            @if (_genAddrTotalPages > 1)
                            {
                                <nav aria-label="Generated Addresses Pagination">
                                    <ul class="pagination pagination-sm mb-0">
                                        <li class="page-item @(_genAddrCurrentPage == 1 ? "disabled" : "")">
                                            <button class="page-link" @onclick="() => _genAddrCurrentPage--">&laquo;</button>
                                        </li>
                                        <li class="page-item active">
                                            <span class="page-link">@_genAddrCurrentPage / @_genAddrTotalPages</span>
                                        </li>
                                        <li class="page-item @(_genAddrCurrentPage == _genAddrTotalPages ? "disabled" : "")">
                                            <button class="page-link" @onclick="() => _genAddrCurrentPage++">&raquo;</button>
                                        </li>
                                    </ul>
                                </nav>
                            }
                        </div>
                    </div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush">
                            @foreach (var addrInfo in _generatedAddresses.Skip((_genAddrCurrentPage - 1) * _pageSize).Take(_pageSize))
                            {
                                <li class="list-group-item d-flex justify-content-between align-items-center font-monospace @(_copiedAddresses.Contains(addrInfo.Address) ? "address-copied" : "")">
                                    <span>
                                        @addrInfo.Address
                                        @if (addrInfo.IsUsed == true)
                                        {
                                            <span class="badge bg-danger ms-2">Used</span>
                                        }
                                        else if (addrInfo.IsUsed == false)
                                        {
                                            <span class="badge bg-success ms-2">Unused</span>
                                        }
                                    </span>
                                    <i class="bi bi-clipboard-check-fill text-success copy-btn" title="Copy to clipboard" @onclick="() => CopyToClipboard(addrInfo.Address)"></i>
                                </li>
                            }
                        </ul>
                    </div>
                </div>
            }

            @if (_scanResults.Any())
            {
                <div class="card mt-4">
                    <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-2">
                        <span>Balance Scan Details (Found: @_foundBalanceCount)</span>
                        <div class="d-flex align-items-center gap-2">
                            <div class="input-group input-group-sm" style="width: 150px;">
                                <span class="input-group-text">Per Page</span>
                                <input type="number" class="form-control" @bind="_pageSize" @bind:event="oninput" min="5" max="100" @onchange="UpdateScanPagination">
                            </div>
                            @if (_scanTotalPages > 1)
                            {
                                <nav aria-label="Scan Results Pagination">
                                    <ul class="pagination pagination-sm mb-0">
                                        <li class="page-item @(_scanCurrentPage == 1 ? "disabled" : "")">
                                            <button class="page-link" @onclick="() => _scanCurrentPage--">&laquo;</button>
                                        </li>
                                        <li class="page-item active">
                                            <span class="page-link">@_scanCurrentPage / @_scanTotalPages</span>
                                        </li>
                                        <li class="page-item @(_scanCurrentPage == _scanTotalPages ? "disabled" : "")">
                                            <button class="page-link" @onclick="() => _scanCurrentPage++">&raquo;</button>
                                        </li>
                                    </ul>
                                </nav>
                            }
                        </div>
                    </div>
                    <div class="card-body" style="max-height: 400px; overflow-y: auto;" id="scan-results-container">
                        <ul class="list-group list-group-flush">
                            @foreach (var result in _scanResults.Skip((_scanCurrentPage - 1) * _pageSize).Take(_pageSize))
                            {
                                <li id="scan-result-@result.Index" class="list-group-item d-flex justify-content-between align-items-center font-monospace flex-wrap">
                                    <div>
                                        <span class="d-block">@result.Index: @result.Address</span>
                                        @if (result.FirstSeenDate.HasValue)
                                        {
                                            <small class="text-muted">First seen: @result.FirstSeenDate.Value.ToString("yyyy-MM-dd")</small>
                                        }
                                    </div>
                                    <div class="d-flex gap-2 flex-wrap justify-content-end mt-1 mt-md-0">
                                        @if (result.TotalFundedSatoshis > 0)
                                        {
                                            <span class="badge bg-info-subtle border border-info-subtle text-info-emphasis rounded-pill" title="Value at time of first transaction">
                                                In: $@(result.TotalFundedValueAtHistoricalPrice?.ToString("N2") ?? "N/A")
                                            </span>
                                        }
                                        @if (result.TotalSpentSatoshis > 0)
                                        {
                                            <span class="badge bg-warning-subtle border border-warning-subtle text-warning-emphasis rounded-pill" title="Value at time of first transaction">
                                                Out: $@(result.TotalSpentValueAtHistoricalPrice?.ToString("N2") ?? "N/A")
                                            </span>
                                        }
                                        @if (result.Balance > 0 && _currentBtcPrice.HasValue)
                                        {
                                            <span class="badge bg-primary-subtle border border-primary-subtle text-primary-emphasis rounded-pill" title="Current value of this address's balance">
                                                Now: $@((Money.Satoshis(result.Balance).ToDecimal(MoneyUnit.BTC) * _currentBtcPrice.Value).ToString("N2"))
                                            </span>
                                        }
                                        @if (result.Balance > 0)
                                        {
                                            <span class="badge bg-success rounded-pill">@Money.Satoshis(result.Balance).ToDecimal(MoneyUnit.BTC) BTC</span>
                                        }
                                        else if (result.TotalFundedSatoshis > 0)
                                        {
                                            <span class="badge bg-secondary rounded-pill">Empty</span>
                                        }
                                    </div>
                                </li>
                            }
                        </ul>
                    </div>
                </div>
            }


            @if (_balanceResult != null)
            {
                <div class="card mt-4">
                    <div class="card-header">Total Balance Result</div>
                    <div class="card-body text-center">
                        <h3 class="display-6">@_balanceResult.ToDecimal(MoneyUnit.BTC) BTC</h3>
                        @if (_currentBtcPrice.HasValue)
                        {
                            <p class="lead text-muted mb-1">≈ $@((_balanceResult.ToDecimal(MoneyUnit.BTC) * _currentBtcPrice.Value).ToString("N2")) USD</p>
                        }
                        @if (_averageCostBasis.HasValue)
                        {
                            <p class="text-muted">Average Cost Basis: <strong>$@_averageCostBasis.Value.ToString("N2")</strong></p>
                        }
                    </div>
                </div>
            }

        </div>
    </div>
</div>


<div class="modal fade" id="configModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Manage Saved xpubs</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-4 p-3 border rounded">
                    <h6>Add a New xpub</h6>
                    @if (!string.IsNullOrEmpty(_modalErrorMessage))
                    {
                        <div class="alert alert-danger p-2">@_modalErrorMessage</div>
                    }
                    <div class="mb-2">
                        <label for="newAlias" class="form-label">Alias (short name)</label>
                        <input type="text" id="newAlias" class="form-control" @bind="_newAlias" placeholder="e.g., My Ledger Wallet">
                    </div>
                    <div class="mb-2">
                        <label for="newXpub" class="form-label">xpub/ypub/zpub</label>
                        <textarea id="newXpub" class="form-control" @bind="_newXpubValue" rows="2"></textarea>
                    </div>
                    <button class="btn btn-sm btn-success" @onclick="SaveNewXpub">Save xpub</button>
                </div>
                <h6>Saved xpubs</h6>
                @if (_config.SavedXpubs.Any())
                {
                    <ul class="list-group">
                        @foreach (var entry in _config.SavedXpubs)
                        {
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong class="d-block">@entry.Key</strong>
                                    <small class="text-muted font-monospace">@Truncate(entry.Value, 15)</small>
                                </div>
                                <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteXpub(entry.Key)">Delete</button>
                            </li>
                        }
                    </ul>
                }
                else
                {
                    <p class="text-muted">No xpubs saved yet.</p>
                }
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="helpModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Help / FAQ: How to get your xpub</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>An xpub (Extended Public Key) allows this tool to view your addresses and balances without needing your private keys. <strong>Your funds are safe.</strong></p>
                <div class="accordion" id="faqAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseLedger" aria-expanded="false" aria-controls="collapseLedger">
                                <img src="images/ledger/ledger.ico" alt="Ledger Icon" class="me-2" style="width: 20px; height: 20px;">
                                <strong>Ledger Wallet</strong>
                            </button>
                        </h2>
                        <div id="collapseLedger" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                            <div class="accordion-body">
                                <ol>
                                    <li>Open <strong>Ledger Live</strong> on your desktop.</li>
                                    <li>Go to the <strong>Accounts</strong> tab and select your Bitcoin account.</li>
                                    <li>Click the <strong>wrench icon</strong> (Settings) in the top-right corner.</li>
                                    <li>In the 'Edit account' window, click on <strong>Advanced Logs</strong>.</li>
                                    <li>Copy the long string that starts with <code>xpub</code>, <code>ypub</code>, or <code>zpub</code>.</li>
                                </ol>
                                <img src="images/ledger/ledger-guide.webp" class="img-fluid rounded" alt="Ledger Live xpub export guide">
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTrezor" aria-expanded="false" aria-controls="collapseTrezor">
                                <img src="images/trezor/trezor.ico" alt="Trezor Icon" class="me-2" style="width: 20px; height: 20px;">
                                <strong>Trezor Wallet</strong>
                            </button>
                        </h2>
                        <div id="collapseTrezor" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                            <div class="accordion-body">
                                <ol>
                                    <li>Connect your Trezor and open the <strong>Trezor Suite</strong> application.</li>
                                    <li>Select your Bitcoin account from the left menu.</li>
                                    <li>Go to the <strong>Account</strong> tab (it might be named 'Details' in some versions).</li>
                                    <li>Click on <strong>Show public key</strong> (or similar wording like 'Account public key').</li>
                                    <li>A modal will appear showing your xpub. You can copy it from there.</li>
                                </ol>
                                <img src="images/trezor/trezor-guide.webp" class="img-fluid rounded" alt="Trezor Suite xpub export guide">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script>
    window.btcUtility = {
        copyToClipboard: function (text) {
            navigator.clipboard.writeText(text).then(function () {
                // Optional: show a toast or notification
            }).catch(function (error) {
                console.error('Error copying text: ', error);
            });
        },
        scrollToElement: function (elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        },
        showToast: function (toastId) {
            const toastEl = document.getElementById(toastId);
            if (toastEl) {
                const toast = new bootstrap.Toast(toastEl);
                toast.show();
            }
        },
        priceSocket: null,
        startPriceWebSocket: function (dotnetHelper) {
            this.priceSocket = new WebSocket('wss://ws-feed.exchange.coinbase.com');

            this.priceSocket.onopen = function (event) {
                const subscribeMessage = {
                    type: 'subscribe',
                    product_ids: ['BTC-USD'],
                    channels: ['ticker']
                };
                this.send(JSON.stringify(subscribeMessage));
            };

            this.priceSocket.onmessage = function (event) {
                try {
                    const priceData = JSON.parse(event.data);
                    if (priceData.type === 'ticker' && priceData.price) {
                        dotnetHelper.invokeMethodAsync('UpdatePriceFromSocket', priceData.price);
                    }
                } catch (e) {
                    // console.error("Failed to parse price data", e);
                }
            };

            this.priceSocket.onerror = function (error) {
                console.error('WebSocket Error: ', error);
            };
        },
        stopPriceWebSocket: function () {
            if (this.priceSocket) {
                this.priceSocket.close();
            }
        },
        initializeTooltips: function () {
            const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
            [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
        }
    };
</script>


@code {
    // #region State Variables
    private AppConfig _config = new();
    private string _currentXpub = "";
    private string _selectedNetworkString = "Main";
    private string _selectedAddressTypeString = "Segwit";

    private List<GeneratedAddressInfo> _generatedAddresses = new();
    private Money? _balanceResult = null;
    private string _statusMessage = "";
    private string _errorMessage = "";
    private bool IsBusy = false;
    private decimal? _currentBtcPrice = null;
    private decimal? _averageCostBasis = null;
    // #endregion

    // #region Advanced Settings State
    private bool _showAdvanced = false;
    private int _gapLimit = 20;
    private int _generateCount = 20;
    private int _pageSize = 20;
    private bool _checkIfAddressUsed = false;
    // #endregion

    // #region Pagination State
    private int _genAddrCurrentPage = 1;
    private int _genAddrTotalPages = 1;
    private int _scanCurrentPage = 1;
    private int _scanTotalPages = 1;
    // #endregion

    // #region Scan State
    private List<ScanResult> _scanResults = new();
    private int _foundBalanceCount = 0;
    private bool _isApproachingGapLimit = false;
    // #endregion

    // #region Modal & UI State
    private string _newAlias = "";
    private string _newXpubValue = "";
    private string _modalErrorMessage = "";
    private bool _isDarkMode = false;
    private string _toastMessage = "";
    private HashSet<string> _copiedAddresses = new();
    // #endregion

    // #region WebSocket State
    private DotNetObjectReference<Home>? _dotNetHelper;
    private DateTime? _lastPriceUpdate;
    // #endregion

    // #region Constants
    private const string ConfigKey = "BtcUtilityConfig";
    private const string ThemeKey = "BtcUtilityTheme";
    private const int GapLimitWarningThreshold = 5;
    // #endregion

    // #region Lifecycle Methods
    protected override async Task OnInitializedAsync()
    {
        _dotNetHelper = DotNetObjectReference.Create(this);
        await LoadConfigAsync();
        await LoadThemeAsync();
        await JSRuntime.InvokeVoidAsync("btcUtility.startPriceWebSocket", _dotNetHelper);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await JSRuntime.InvokeVoidAsync("btcUtility.initializeTooltips");
    }

    public async ValueTask DisposeAsync()
    {
        await JSRuntime.InvokeVoidAsync("btcUtility.stopPriceWebSocket");
        _dotNetHelper?.Dispose();
        GC.SuppressFinalize(this);
    }
    // #endregion

    // #region Main Logic
    private async Task GenerateAddresses()
    {
        _errorMessage = "";
        if (!ValidateInputs(out var network, out var addressType, out var extPubKey)) return;

        IsBusy = true;

        int startIndex = _generatedAddresses.Count;
        for (int i = 0; i < _generateCount; i++)
        {
            var currentIndex = (uint)(startIndex + i);
            _statusMessage = $"Generating & Verifying Index {currentIndex}...";
            StateHasChanged();

            var address = GenerateAddressByIndex(extPubKey, currentIndex, network, addressType);
            bool? isUsed = null;
            if (_checkIfAddressUsed)
            {
                isUsed = await CheckAddressUsage(address.ToString(), network);
            }
            _generatedAddresses.Add(new GeneratedAddressInfo { Address = address.ToString(), IsUsed = isUsed });
        }

        UpdateGenAddrPagination();
        IsBusy = false;
    }

    private async Task CheckBalance()
    {
        ClearResults();
        if (!ValidateInputs(out var network, out var addressType, out var extPubKey)) return;

        IsBusy = true;
        StateHasChanged();

        long totalBalanceSatoshis = 0;
        decimal totalWeightedCostOfBalance = 0;
        int consecutiveUnused = 0;
        uint index = 0;
        string apiEndpoint = network == Network.Main ? "api" : "api/testnet";

        while (consecutiveUnused < _gapLimit)
        {
            var address = GenerateAddressByIndex(extPubKey, index, network, addressType);

            _isApproachingGapLimit = (_gapLimit - consecutiveUnused) <= GapLimitWarningThreshold;
            _statusMessage = $"Scanning Index {index}... (Empty streak: {consecutiveUnused}/{_gapLimit})";
            StateHasChanged();

            try
            {
                var response = await Http.GetStringAsync($"https://blockstream.info/{apiEndpoint}/address/{address}");
                using var doc = JsonDocument.Parse(response);
                var chainStats = doc.RootElement.GetProperty("chain_stats");
                int txCount = chainStats.GetProperty("tx_count").GetInt32();

                var scanResult = new ScanResult { Index = $"#{index}", Address = address.ToString(), Balance = 0 };

                if (txCount > 0)
                {
                    long fundedSum = chainStats.GetProperty("funded_txo_sum").GetInt64();
                    long spentSum = chainStats.GetProperty("spent_txo_sum").GetInt64();
                    long balance = fundedSum - spentSum;

                    scanResult.Balance = balance;
                    scanResult.TotalFundedSatoshis = fundedSum;
                    scanResult.TotalSpentSatoshis = spentSum;

                    if (balance > 0)
                    {
                        totalBalanceSatoshis += balance;
                        _foundBalanceCount++;
                    }

                    await Task.Delay(250);
                    await FetchHistoricalPrice(scanResult);

                    if (balance > 0 && scanResult.HistoricalPrice.HasValue)
                    {
                        decimal btcBalanceForAddress = Money.Satoshis(balance).ToDecimal(MoneyUnit.BTC);
                        totalWeightedCostOfBalance += btcBalanceForAddress * scanResult.HistoricalPrice.Value;
                    }

                    consecutiveUnused = 0;
                }
                else
                {
                    consecutiveUnused++;
                }
                _scanResults.Add(scanResult);
                UpdateScanPagination();
                StateHasChanged();
                await JSRuntime.InvokeVoidAsync("btcUtility.scrollToElement", $"scan-result-#{index}");

            }
            catch (HttpRequestException)
            {
                consecutiveUnused++;
                _scanResults.Add(new ScanResult { Index = $"#{index}", Address = address.ToString(), Balance = 0 });
            }
            catch (Exception ex)
            {
                _errorMessage = $"An unexpected error occurred at index {index}: {ex.Message}";
                IsBusy = false;
                return;
            }
            index++;
        }

        _balanceResult = Money.Satoshis(totalBalanceSatoshis);
        var totalBtcInWallet = _balanceResult.ToDecimal(MoneyUnit.BTC);
        if (totalBtcInWallet > 0)
        {
            _averageCostBasis = totalWeightedCostOfBalance / totalBtcInWallet;
        }

        IsBusy = false;
    }
    // #endregion

    // #region API & Data Fetching
    private async Task FetchHistoricalPrice(ScanResult scanResult)
    {
        try
        {
            string apiEndpoint = GetNetworkFromString(_selectedNetworkString) == Network.Main ? "api" : "api/testnet";
            var txsResponse = await Http.GetStringAsync($"https://blockstream.info/{apiEndpoint}/address/{scanResult.Address}/txs");
            using var txsDoc = JsonDocument.Parse(txsResponse);
            var firstTx = txsDoc.RootElement.EnumerateArray().LastOrDefault();

            if (firstTx.TryGetProperty("status", out var status) && status.TryGetProperty("block_time", out var blockTime))
            {
                var txDateTime = DateTimeOffset.FromUnixTimeSeconds(blockTime.GetInt64());
                scanResult.FirstSeenDate = txDateTime.DateTime;

                string dateForApi = txDateTime.ToString("yyyy-MM-dd", CultureInfo.InvariantCulture);

                var priceResponse = await Http.GetStringAsync($"https://api.coinbase.com/v2/prices/BTC-USD/spot?date={dateForApi}");
                using var priceDoc = JsonDocument.Parse(priceResponse);
                if (priceDoc.RootElement.TryGetProperty("data", out var data) && data.TryGetProperty("amount", out var amount))
                {
                    var historicalPrice = decimal.Parse(amount.GetString()!);
                    scanResult.HistoricalPrice = historicalPrice;
                    scanResult.TotalFundedValueAtHistoricalPrice = Money.Satoshis(scanResult.TotalFundedSatoshis).ToDecimal(MoneyUnit.BTC) * historicalPrice;
                    scanResult.TotalSpentValueAtHistoricalPrice = Money.Satoshis(scanResult.TotalSpentSatoshis).ToDecimal(MoneyUnit.BTC) * historicalPrice;
                }
            }
        }
        catch { /* Ignore errors, price is optional */ }
    }

    [JSInvokable]
    public void UpdatePriceFromSocket(string newPrice)
    {
        if (decimal.TryParse(newPrice, out var price))
        {
            _currentBtcPrice = price;
            _lastPriceUpdate = DateTime.Now;
            StateHasChanged();
        }
    }
    // #endregion

    // #region UI Event Handlers
    private void OnSavedXpubSelected(ChangeEventArgs e)
    {
        var alias = e.Value?.ToString();
        if (!string.IsNullOrEmpty(alias) && _config.SavedXpubs.TryGetValue(alias, out var xpub))
        {
            _currentXpub = xpub;
        }
    }

    private void ToggleAdvancedSettings()
    {
        _showAdvanced = !_showAdvanced;
    }
    // #endregion

    // #region Helper Methods
    private bool ValidateInputs(out Network network, out ScriptPubKeyType addressType, out BitcoinExtPubKey extPubKey)
    {
        network = GetNetworkFromString(_selectedNetworkString);
        addressType = GetAddressTypeFromString(_selectedAddressTypeString);
        extPubKey = null!;

        var sanitizedXpub = SanitizeBase58String(_currentXpub);

        if (string.IsNullOrWhiteSpace(sanitizedXpub))
        {
            _errorMessage = "Please enter or select an xpub.";
            return false;
        }

        try
        {
            extPubKey = new BitcoinExtPubKey(sanitizedXpub, network);
            if (_currentXpub != sanitizedXpub)
            {
                _currentXpub = sanitizedXpub;
                StateHasChanged();
            }
            return true;
        }
        catch (FormatException)
        {
            _errorMessage = "Invalid xpub format or checksum. Please double-check the key and the selected network. This error can also be caused by invisible characters copied from other sources.";
            return false;
        }
    }

    private async Task<bool> CheckAddressUsage(string address, Network network)
    {
        string apiEndpoint = network == Network.Main ? "api" : "api/testnet";
        try
        {
            var response = await Http.GetStringAsync($"https://blockstream.info/{apiEndpoint}/address/{address}");
            using var doc = JsonDocument.Parse(response);
            return doc.RootElement.GetProperty("chain_stats").GetProperty("tx_count").GetInt32() > 0;
        }
        catch (HttpRequestException)
        {
            return false; // 404 means not used
        }
        catch
        {
            return false; // Other errors, assume not used
        }
    }

    private void ClearResults()
    {
        _errorMessage = "";
        _generatedAddresses.Clear();
        _balanceResult = null;
        _scanResults.Clear();
        _foundBalanceCount = 0;
        _isApproachingGapLimit = false;
        _genAddrCurrentPage = 1;
        _scanCurrentPage = 1;
        _copiedAddresses.Clear();
        _averageCostBasis = null;
    }

    private Network GetNetworkFromString(string networkString)
    {
        return networkString == "Main" ? Network.Main : Network.TestNet;
    }

    private ScriptPubKeyType GetAddressTypeFromString(string addressTypeString)
    {
        return addressTypeString switch
        {
            "Legacy" => ScriptPubKeyType.Legacy,
            "SegwitP2SH" => ScriptPubKeyType.SegwitP2SH,
            _ => ScriptPubKeyType.Segwit // Default
        };
    }

    private BitcoinAddress GenerateAddressByIndex(BitcoinExtPubKey extPubKey, uint addressIndex, Network network, ScriptPubKeyType addressType)
    {
        var derivationPath = new KeyPath($"0/{addressIndex}");
        var derivedPubKey = extPubKey.Derive(derivationPath);
        var pubKey = derivedPubKey.GetPublicKey();
        return pubKey.GetAddress(addressType, network);
    }

    private string Truncate(string text, int maxLength)
    {
        if (string.IsNullOrEmpty(text))
        {
            return string.Empty;
        }
        return text.Length <= maxLength ? text : $"{text.Substring(0, maxLength)}...";
    }

    private string SanitizeBase58String(string? input)
    {
        if (string.IsNullOrWhiteSpace(input))
        {
            return string.Empty;
        }
        return Regex.Replace(input, "[^1-9A-HJ-NP-Za-km-z]", "");
    }
    // #endregion

    // #region Config and Modal Logic
    private async Task LoadConfigAsync()
    {
        try
        {
            var json = await JSRuntime.InvokeAsync<string>("localStorage.getItem", ConfigKey);
            if (!string.IsNullOrEmpty(json))
            {
                _config = JsonSerializer.Deserialize<AppConfig>(json) ?? new AppConfig();
            }
        }
        catch { /* Ignore JS interop errors on first load */ }
    }

    private async Task SaveConfigAsync()
    {
        try
        {
            var json = JsonSerializer.Serialize(_config);
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", ConfigKey, json);
        }
        catch { /* Ignore JS interop errors */ }
    }

    private async Task ShowConfigModal()
    {
        _modalErrorMessage = "";
        await JSRuntime.InvokeVoidAsync("eval", "new bootstrap.Modal(document.getElementById('configModal')).show()");
    }

    private async Task ShowHelpModal()
    {
        await JSRuntime.InvokeVoidAsync("eval", "new bootstrap.Modal(document.getElementById('helpModal')).show()");
    }

    private async Task SaveNewXpub()
    {
        _modalErrorMessage = "";

        var trimmedAlias = _newAlias?.Trim();
        var sanitizedXpubValue = SanitizeBase58String(_newXpubValue);

        if (string.IsNullOrWhiteSpace(trimmedAlias))
        {
            _modalErrorMessage = "Alias cannot be empty.";
            return;
        }
        if (_config.SavedXpubs.ContainsKey(trimmedAlias))
        {
            _modalErrorMessage = "This alias already exists.";
            return;
        }
        if (string.IsNullOrWhiteSpace(sanitizedXpubValue))
        {
            _modalErrorMessage = "xpub cannot be empty.";
            return;
        }

        try
        {
            new BitcoinExtPubKey(sanitizedXpubValue, GetNetworkFromString(_selectedNetworkString));
        }
        catch
        {
            _modalErrorMessage = "Invalid xpub format or checksum.";
            return;
        }

        _config.SavedXpubs[trimmedAlias] = sanitizedXpubValue;
        _newAlias = "";
        _newXpubValue = "";
        await SaveConfigAsync();
    }

    private async Task DeleteXpub(string alias)
    {
        if (_config.SavedXpubs.ContainsKey(alias))
        {
            _config.SavedXpubs.Remove(alias);
            await SaveConfigAsync();
        }
    }
    // #endregion

    // #region Dark Mode Logic
    private async Task ToggleTheme()
    {
        _isDarkMode = !_isDarkMode;
        await SetThemeAsync();
    }

    private async Task LoadThemeAsync()
    {
        try
        {
            var theme = await JSRuntime.InvokeAsync<string>("localStorage.getItem", ThemeKey);
            if (theme != null)
            {
                _isDarkMode = theme == "dark";
            }
            else
            {
                var hour = DateTime.Now.Hour;
                _isDarkMode = hour < 6 || hour >= 18;
            }
            await SetThemeAsync(false);
        }
        catch { /* Ignore JS interop errors */ }
    }

    private async Task SetThemeAsync(bool save = true)
    {
        var theme = _isDarkMode ? "dark" : "light";
        await JSRuntime.InvokeVoidAsync("eval", $"document.documentElement.setAttribute('data-bs-theme', '{theme}')");
        if (save)
        {
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", ThemeKey, theme);
        }
    }
    // #endregion

    // #region Pagination & UI Interaction
    private void UpdateGenAddrPagination()
    {
        _genAddrTotalPages = (int)Math.Ceiling(_generatedAddresses.Count / (double)_pageSize);
        if (_genAddrCurrentPage > _genAddrTotalPages) _genAddrCurrentPage = _genAddrTotalPages;
        if (_genAddrCurrentPage < 1) _genAddrCurrentPage = 1;
    }

    private void UpdateScanPagination()
    {
        _scanTotalPages = (int)Math.Ceiling(_scanResults.Count / (double)_pageSize);
        if (_scanCurrentPage > _scanTotalPages) _scanCurrentPage = _scanTotalPages;
        if (_scanCurrentPage < 1) _scanCurrentPage = 1;
    }

    private async Task CopyToClipboard(string text)
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("btcUtility.copyToClipboard", text);
            _toastMessage = $"Copied: {Truncate(text, 20)}";
            _copiedAddresses.Add(text);
            await JSRuntime.InvokeVoidAsync("btcUtility.showToast", "copyToast");
        }
        catch (Exception ex)
        {
            _errorMessage = $"Copy failed: {ex.Message}";
        }
    }
    // #endregion

    // #region Data Models
    public class AppConfig
    {
        public Dictionary<string, string> SavedXpubs { get; set; } = new();
    }

    public class ScanResult
    {
        public required string Index { get; set; }
        public required string Address { get; set; }
        public long Balance { get; set; }
        public long TotalFundedSatoshis { get; set; }
        public long TotalSpentSatoshis { get; set; }
        public decimal? HistoricalPrice { get; set; }
        public DateTime? FirstSeenDate { get; set; }
        public decimal? TotalFundedValueAtHistoricalPrice { get; set; }
        public decimal? TotalSpentValueAtHistoricalPrice { get; set; }
    }

    public class GeneratedAddressInfo
    {
        public required string Address { get; set; }
        public bool? IsUsed { get; set; } // null = not checked, true = used, false = unused
    }
    // #endregion
}
